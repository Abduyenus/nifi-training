pipeline {
    agent any

    environment {
        NIFI_URL = 'https://localhost:8443/nifi-api'
        PROJECT_DIR = 'default/nifi-automation'
    }

    stages {
        stage('Checkout and Validate') {
            steps {
                checkout scm
                echo '‚úÖ Code checked out successfully from GitHub'
                
                dir(env.PROJECT_DIR) {
                    script {
                        if (!fileExists('template.xml')) {
                            bat 'dir'
                            error '‚ùå template.xml not found in project directory!'
                        }
                        echo '‚úÖ template.xml found'
                    }
                }
            }
        }
        
        stage('Deploy to NiFi') {
            steps {
                dir(env.PROJECT_DIR) {
                    bat """
                        echo Starting NiFi deployment...
                        powershell -File "deploy-nifi.ps1" -NifiApiUrl "${env.NIFI_URL}"
                    """
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                bat """
                    powershell -Command "& {
                        [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { \\$true }
                        try {
                            \\$response = Invoke-RestMethod -Uri '${env.NIFI_URL}/flow/process-groups/root' -Method Get
                            Write-Host '‚úÖ NiFi deployment verified!' -ForegroundColor Green
                        } catch {
                            Write-Warning '‚ö†Ô∏è Could not verify NiFi deployment'
                        }
                    }"
                """
            }
        }
    }
    
    post {
        success {
            echo 'üéâ NiFi deployment completed successfully!'
        }
        failure {
            echo 'üí• NiFi deployment failed!'
        }
    }
}
